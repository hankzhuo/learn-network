## CIDR 

无类型域间选路（CIDR），将 32 为 IP 分为两部分，网络号和主机号。

10.100.122.2/24：表示前24位是网络号，后八位是主机号，先转换为二进制表示：0001010.1100100.1111010.10

- **广播地址**：10.100.122.255/24，如果发送这个地址，所有 10.100.122.x 网络里面的机器都可以收到消息。
- **子网掩码**：将网络号二进制全部设置为1，计算得到子网掩码 255.255.255.0

有相同网络号的地址，都在同一网络下。

例如：
16.158.165.91/22 二进制表示：00010000.10011110.10100101.01011011。前22位位网络号，后面10位位主机号。
第一个地址：16.158.164.1
子网掩码：255.255.252.0
广播地址：00010000.10011110.10100111.11111111 => 16.158.167.255


链路层地址 MAC（Media Access Control Address）：
- 实现本地网络设备间的直接传输

网络层地址 IP（Internet Protocol address）：
- 实现大型网络间传输


## ARP 协议

从 IP 地址寻找到 MAC 地址，MAC 地址是唯一的。

- 主机 A 想和主机 B 通讯，但主机 A 只知道主机 B 的 IP 地址，但是交换机只认识 MAC 地址，所以先需要获取到主机 B 的 MAC 地址。可以通过广播（Broadcast）形式，带着 B 的 IP 地址去询问 MAC 地址，B 收到询问后会返回自己的 MAC 地址。
- 可以通过缓存，减少广播


RARP 协议：
- 从 MAC 地址中寻找 IP 地址，以 ARP 协议类似，也是通过广播。

## NAT

NAT：Network Address Translator 网络地址交换

公网地址和内网地址

单向（向外）转换 NAT：动态映射
- 内网有一台主机 A (私有地址 10.0.0.1，公网不认识这个地址) 想访问外网中一个主机 B（地址 204.51.12.14）
- 通过 NAT 路由时，NAT 路由会把报文中内网 A 的私有地址转换为公网 IP，比如 194.54.21.1
- 目标主机 B 收到的地址就是修改后的外网地址
- 主机 B 返回信息给 NAT 路由时，NAT 路由又会把公网 IP 转换为 A 的私有地址


NAPT 端口映射：Network Address Port Translation
- 当一个路由下有很多设备时，同用一个 IP 内网地址时，NAPT 通过修改端口号来区分设备


## IP 选路

- 直接传输
  - 同一个网络内主机之间可以根据 MAC 地址通过交换机直接传输
- 本地网络间接传输
  - 内部选路协议
    - RIP
    - OSPF
- 公网间接传输
  - 外部选路协议
    - BGP

路由表：每个路由器负责自己网段，比如 A => B => C 三个路由，路由 A 如果要访问路由 C ，只需要发给路由 B ，路由 B 再发给 路由 C，不能路由 A 直接发给路由 C。

RIP协议（Routing Information Protocol）：
- 特点：
  - 基于跳数确定路由（经过路由器的个数计数）
  - UDP 协议向相邻路由器通知路由表
- 问题：
  - 跳数度量
  - 慢收敛
  - 选路环路

OSPF 协议（Open Shortest Path First）：
- 多级拓扑结构：同级拓扑中每台路由器都具有最终相同的数据信息
  - 直接使用 IP 协议（协议号 0x06 为 TCP，0x11 为 UDP，而 0x59 为 OSPF）传递路由信息
- OSPF 最短路径树

BGP（Border GateWay Protocol）：
- 存放网络间信息 RIB
  - Routing Information Base
  - TCP 协议传输 RIB 信息
- 分类：
  - EBGP：外部对等方传输
  - IBGP：内部对等方传输


## IP 报文

- Identification：分片标识
- Flags：分片控制
  - Don't fragment: 1，表示不分片
  - More fragment：1，表示中间分片
  - Fragment offset 分片偏移
- Protocol：承载的协议

MTU（Maximum Transmission Unit）分片：
- MTU 最大传输单元 >= 576 字节
- 不同网络的 MTU 大小是不一样


