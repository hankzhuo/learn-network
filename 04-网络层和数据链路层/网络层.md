# IP 

## CIDR

无类型域间选路（CIDR），将 32 为 IP 分为两部分，网络号和主机号。

10.100.122.2/24
这个 IP 的意思是，前24位是网络号，后八位是主机号。
**广播地址**：10.100.122.255/24，如果发送这个地址，所有 10.100.122 网络里面的机器都可以收到。
**子网掩码**：255.255.255.0
将子网掩码和 IP 地址按位运算 AND，可以得到**网络号**：10.100.122.0

16.158.165.91/22
前22位位网络号，后面10位位主机号
第一个地址：16.158.<101001><00>.1  => 16.158.164.1
子网掩码：255.255.<111111><00>.0  => 255.255.252.0
广播地址：16.158.<101001><11>.255  => 16.158.167.255

## 公有 IP 和私有 IP

私有 IP 是可以一样的，公有 IP 是唯一的。

## MAC 地址

fe80::3144:6af9:b67a:43df 12
一个网卡的物理地址，16进制，出厂就有的

同一个局域网内，是可以通过 MAC 地址通讯的，但不在一个局域网内，就要用到 IP 地址。
比如 192.168.0.2/24 和 192.168.0.3/24 可以通过 MAC 地址通讯，但192.168.0.2/24 和 192.168.1.3/24 不可以。

## 动态主机配置协议（DHCP）

DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，要商谈、签约、续租，广播还不能“抢单”；
来的时候，分配一个 ip 上网，断掉一段时间后，就收回这个 ip。


## 网关

网关地址一定是和源 IP 地址是一个网段的。
例如 192.168.1.0/24 这个网段，Gateway往往会是 192.168.1.1/24 或者 192.168.1.2/24。

网关是路由器的一个网口。
网关往往是一个路由器，是一个三层转发的设备。

啥叫三层设备？前面也说过了，就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

### 转发网关

不改变 IP 地址的网关。

![](leanote://file/getImage?fileId=5d6bcf97139a044ba2000000)

服务器 A 要访问服务器 B。首先，服务器 A 会思考，192.168.4.101 和我不是一个网段的，因而需要先发给网关。那网关是谁呢？已经静态配置好了，网关是 192.168.1.1。网关的 MAC 地址是多少呢？发送 ARP 获取网关的 MAC 地址，然后发送包。包的内容是这样的：

- 源 MAC：服务器 A 的 MAC
- 目标 MAC：192.168.1.1 这个网口的 MAC
- 源 IP：192.168.1.101
- 目标 IP：192.168.4.101

包到达 192.168.1.1 这个网口，发现 MAC 一致，将包收进来，开始思考往哪里转发。

在路由器 A 中配置了静态路由之后，要想访问 192.168.4.0/24，要从 192.168.56.1 这个口出去，下一跳为 192.168.56.2。

经过一系列的网关的跳转，最终达到目标服务器。这一过程中，网关地址会改变，IP 地址不会变。

### NAT 网关

改变 IP 地址的网关。Network Address Translation，简称（NAT）。

因为网段通常有外网和内网的 IP，当我们把包发出去时候，都被路由器 NAT 转换了。


## 路由

路由器就是一台网络设备，它有多张网卡。当一个入口的网络包送到路由器时，它会根据一个本地的转发信息库，来决定如何正确地转发流量。这个转发信息库通常被称为**路由表**。

一张路由表中会有多条路由规则。每一条规则至少包含这三项信息。

- 目的网络：这个包想去哪儿？
- 出口设备：将包从哪个口扔出去？
- 下一跳网关：下一个路由器的地址。

通过 route 命令和 ip route 命令都可以进行查询或者配置。

### 静态路由

静态路由就是在路由器上，先配置好一条条规则，要怎么走都是预先定好的。

这些规则包括：想访问 BBS 站（它肯定有个网段），从 2 号口出去，下一跳是 IP2；想访问教学视频站（它也有个自己的网段），从 3 号口出去，下一跳是 IP3，然后保存在路由器里。


### 动态路由

使用动态路由路由器，可以根据路由协议算法生成动态路由表，随网络运行状况的变化而变化，找到最短路径。

动态路由主流算法有两种，**距离矢量路由算法**和**链路状态算法**。基于两种算法产生两种协议，BGP 协议和 OSPF 协议。

**距离矢量路由算法**：

基本思路是，每个路由器都保存一个路由表，包含多行，每行对应网络中的一个路由器，每一行包含两部分信息，一个是要到目标路由器，从哪条线出去，另一个是到目标路由器的距离。

由此可以看出，每个路由器都是知道全局信息的。那这个信息如何更新呢？每个路由器都知道自己和邻居之间的距离，每过几秒，每个路由器都将自己所知的到达所有的路由器的距离告知邻居，每个路由器也能从邻居那里得到相似的信息。

基于距离矢量路由算法的协议 **BGP（Border GateWay Protocol，外网路由协议）**。

**链路状态路由算法**：

这种算法的基本思路是：当一个路由器启动的时候，首先是发现邻居，向邻居 say hello，邻居都回复。然后计算和邻居的距离，发送一个 echo，要求马上返回，除以二就是距离。然后将自己和邻居之间的链路状态包广播出去，发送到整个网络的每个路由器。这样每个路由器都能够收到它和邻居之间的关系的信息。因而，每个路由器都能在自己本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。

基于链路状态路由算法协议 **OSPF（Open Shortest Path First，开放式最短路径优先**）。